<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DartLink - 501 Scoring</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }

        .history {
            max-height: 300px;
            overflow-y: auto;
        }

        .keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }

        .keypad button,
        .per-dart-keypad button {
            width: 100%;
        }

        .multiplier-toggle .btn {
            width: 33%;
        }

        .tab-content>.tab-pane {
            display: none;
        }

        .tab-content>.active {
            display: block;
        }

        .dart-score-boxes {
            display: flex;
            justify-content: center;
            margin-bottom: 1rem;
            gap: 1rem;
        }

        .dart-score-box {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            background-color: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            font-weight: bold;
            position: relative;
        }

        .dart-score-box.active {
            border: 2px solid #0d6efd;
            background-color: #ffffff;
        }

        .dart-score-box::before {
            content: "586";
            font-family: 'bootstrap-icons';
            position: absolute;
            top: -12px;
            font-size: 1rem;
        }
    </style>
</head>

<body>

    <div id="mode-screen" class="container py-5 text-center">
        <h1 class="mb-4">Welcome to DartLink</h1>
        <p class="lead">Select Game Type</p>
        <ul class="nav nav-tabs justify-content-center mb-4" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" id="single-tab" onclick="selectGameType('single')">Single
                    Player</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="multi-tab" onclick="selectGameType('multi')">Multiplayer</button>
            </li>
        </ul>
        <button class="btn btn-primary btn-lg mt-3" onclick="proceedToGameMode()">Continue</button>
    </div>

    <div id="name-screen" class="container py-5 text-center d-none">
        <h1 class="mb-4">Multiplayer Setup</h1>
        <p class="lead">Enter player names</p>
        <div class="row mb-3">
            <div class="col">
                <input id="player1-name" class="form-control form-control-lg" placeholder="Player 1 Name" />
            </div>
            <div class="col">
                <input id="player2-name" class="form-control form-control-lg" placeholder="Player 2 Name" />
            </div>
        </div>
        <button class="btn btn-primary btn-lg" onclick="continueToGameModes()">Continue</button>
    </div>



    <div id="start-screen" class="container py-5 text-center">
        <h1 class="mb-4">Welcome to DartLink</h1>
        <p class="lead">Choose your game mode</p>
        <div class="my-4">
            <label for="legs-input" class="form-label">Legs to play</label>
            <input type="number" id="legs-input" class="form-control w-auto mx-auto" min="1" value="1"
                style="text-align: center;">
        </div>
        <div class="d-flex justify-content-center gap-4">
            <button class="btn btn-outline-primary btn-lg" onclick="startGame(501)">501</button>
            <button class="btn btn-outline-secondary btn-lg" onclick="startGame(301)">301</button>
        </div>
    </div>

    <div id="game-screen" class="container py-5 d-none">
        <div class="row mb-4">
            <div class="col text-center">
                <h1>DartLink</h1>
                <button class="btn btn-outline-secondary" onclick="goToMenu()">
                    <i class="bi-arrow-left me-1"></i>Back to Menu
                </button>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-6 offset-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <div id="players" class="d-flex justify-content-around mb-3">
                            <!-- Player score boxes will be rendered here -->
                        </div>

                        <ul class="nav nav-tabs mb-3" role="tablist">
                            <li class="nav-item">
                                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#total"
                                    type="button" onclick="setInputMode('total')">
                                    <i class="bi-calculator me-1"></i>Total Score
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#perdart" type="button"
                                    onclick="setInputMode('perDart')">
                                    <i class="bi-feather2 me-2"></i><span>Per Dart</span>
                                </button>
                            </li>
                        </ul>

                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="total">
                                <div id="score-display" class="form-control text-center mb-3"
                                    style="font-size: 1.5rem;">0</div>
                                <div class="keypad">
                                    <button class="btn btn-light" onclick="appendScore('1')">1</button>
                                    <button class="btn btn-light" onclick="appendScore('2')">2</button>
                                    <button class="btn btn-light" onclick="appendScore('3')">3</button>
                                    <button class="btn btn-light" onclick="appendScore('4')">4</button>
                                    <button class="btn btn-light" onclick="appendScore('5')">5</button>
                                    <button class="btn btn-light" onclick="appendScore('6')">6</button>
                                    <button class="btn btn-light" onclick="appendScore('7')">7</button>
                                    <button class="btn btn-light" onclick="appendScore('8')">8</button>
                                    <button class="btn btn-light" onclick="appendScore('9')">9</button>
                                    <button class="btn btn-light" onclick="clearScore()">C</button>
                                    <button class="btn btn-light" onclick="appendScore('0')">0</button>
                                    <button class="btn btn-success" onclick="submitScore()"><i
                                            class="bi-check-circle me-1"></i>Enter</button>
                                </div>
                            </div>

                            <div class="tab-pane fade" id="perdart">
                                <div class="dart-score-boxes">
                                    <div class="dart-score-box" id="dart-box-0">-</div>
                                    <div class="dart-score-box" id="dart-box-1">-</div>
                                    <div class="dart-score-box" id="dart-box-2">-</div>
                                </div>

                                <div class="btn-group w-100 mb-3" role="group">
                                    <button type="button" class="btn btn-outline-primary active"
                                        onclick="setMultiplier('Single')">Single</button>
                                    <button type="button" class="btn btn-outline-primary"
                                        onclick="setMultiplier('Double')">Double</button>
                                    <button type="button" class="btn btn-outline-primary"
                                        onclick="setMultiplier('Treble')">Treble</button>
                                </div>

                                <div class="keypad">
                                    <button class="btn btn-light" onclick="inputDart(1)">1</button>
                                    <button class="btn btn-light" onclick="inputDart(2)">2</button>
                                    <button class="btn btn-light" onclick="inputDart(3)">3</button>
                                    <button class="btn btn-light" onclick="inputDart(4)">4</button>
                                    <button class="btn btn-light" onclick="inputDart(5)">5</button>
                                    <button class="btn btn-light" onclick="inputDart(6)">6</button>
                                    <button class="btn btn-light" onclick="inputDart(7)">7</button>
                                    <button class="btn btn-light" onclick="inputDart(8)">8</button>
                                    <button class="btn btn-light" onclick="inputDart(9)">9</button>
                                    <button class="btn btn-light" onclick="inputDart(10)">10</button>
                                    <button class="btn btn-light" onclick="inputDart(11)">11</button>
                                    <button class="btn btn-light" onclick="inputDart(12)">12</button>
                                    <button class="btn btn-light" onclick="inputDart(13)">13</button>
                                    <button class="btn btn-light" onclick="inputDart(14)">14</button>
                                    <button class="btn btn-light" onclick="inputDart(15)">15</button>
                                    <button class="btn btn-light" onclick="inputDart(16)">16</button>
                                    <button class="btn btn-light" onclick="inputDart(17)">17</button>
                                    <button class="btn btn-light" onclick="inputDart(18)">18</button>
                                    <button class="btn btn-light" onclick="inputDart(19)">19</button>
                                    <button class="btn btn-light" onclick="inputDart(20)">20</button>
                                    <button class="btn btn-light" onclick="inputDart(25)">Outer</button>
                                    <button class="btn btn-light" onclick="inputDart(50)">Bull</button>
                                    <button class="btn btn-warning" onclick="inputDart(0)">Miss</button>
                                    <button class="btn btn-secondary" onclick="undoLastDart()"><i
                                            class="bi-arrow-left-circle me-1"></i>Undo Dart</button>
                                </div>
                            </div>
                        </div>

                        <button class="btn btn-secondary w-100 mt-3" onclick="undoScore()"><i
                                class="bi-arrow-counterclockwise me-1"></i>Undo</button>
                        <hr>
                        <div id="checkout-suggestion" class="alert alert-info d-none mt-3" role="alert">
                            <strong>Checkout Suggestion:</strong> <span id="checkout-text"></span>
                        </div>
                        <div id="win-screen" class="alert alert-success d-none mt-3" role="alert">
                            <strong>ðŸŽ‰ Game Over!</strong> You've checked out successfully.
                        </div>
                        <div class="history text-start">
                            <h5>Score History</h5>
                            <ul id="score-history" class="list-group"></ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="stats-screen" class="container py-5 d-none">
        <h1 class="text-center mb-4">ðŸŽ¯ Match Stats</h1>
        <div id="stats-container" class="row">
            <!-- Stats for each player will be injected here -->
        </div>
        <div class="text-center mt-4">
            <button class="btn btn-primary" onclick="goToMenu()">Back to Menu</button>
        </div>
    </div>

    <script>
        let legsToWin = 1;
        let playerLegs = [];
        let startingScore = 501;
        let currentScore = startingScore;
        const gameScreen = document.getElementById('game-screen');
        const startScreen = document.getElementById('start-screen');
        const history = [[]]; // one sub-array per leg
        let inputBuffer = '';
        let inputMode = 'total';
        let perDartScores = [null, null, null];
        let dartIndex = 0;
        let multiplier = 'Single';

        const bogeyNumbers = [159, 162, 163, 165, 166, 168, 169];

        const modeScreen = document.getElementById('mode-screen');
        let gameType = 'single'; // 'single' or 'multi'

        function selectGameType(type) {
            gameType = type;
            document.getElementById('single-tab').classList.toggle('active', type === 'single');
            document.getElementById('multi-tab').classList.toggle('active', type === 'multi');
        }

        function proceedToGameMode() {
            modeScreen.classList.add('d-none');
            if (gameType === 'multi') {
                document.getElementById('name-screen').classList.remove('d-none');
            } else {
                startScreen.classList.remove('d-none');
            }
        }

        let players = [];
        let playerScores = [];
        let currentPlayerIndex = 0;

        function continueToGameModes() {
            const name1 = document.getElementById('player1-name').value.trim() || "Player 1";
            const name2 = document.getElementById('player2-name').value.trim() || "Player 2";
            players = [name1, name2];
            playerScores = [startingScore, startingScore];
            currentPlayerIndex = 0;

            document.getElementById('name-screen').classList.add('d-none');
            startScreen.classList.remove('d-none');
        }



        function startGame(mode) {
            startingScore = parseInt(mode);
            inputBuffer = '';
            perDartScores = [null, null, null];
            dartIndex = 0;
            history.length = 0;
            history.push([]); // Start first leg
            currentPlayerIndex = 0;
            legsToWin = parseInt(document.getElementById('legs-input').value) || 1;
            playerLegs = gameType === 'multi' ? [0, 0] : [0];

            if (gameType === 'multi') {
                playerScores = [startingScore, startingScore];
            } else {
                currentScore = startingScore;
            }

            document.getElementById('name-screen').classList.add('d-none');
            startScreen.classList.add('d-none');
            gameScreen.classList.remove('d-none');
            updateUI();
        }



        function appendScore(digit) {
            if (inputBuffer.length < 3) {
                inputBuffer += digit;
                updateUI();
            }
        }

        function clearScore() {
            inputBuffer = '';
            updateUI();
        }



        function submitScore() {
            const score = parseInt(inputBuffer);
            if (isNaN(score) || score < 0 || score > 180) {
                alert("Please enter a valid score between 0 and 180.");
                return;
            }

            let current = gameType === 'multi' ? playerScores[currentPlayerIndex] : currentScore;
            const newScore = current - score;

            const isValidCheckout = newScore === 0 && !bogeyNumbers.includes(current);

            if (isValidCheckout) {
                const latestScore = score;

                history[history.length - 1].push({
                    player: gameType === 'multi' ? players[currentPlayerIndex] : "You",
                    score: score,
                    darts: 3,
                    isCheckout: true,
                    legIndex: history.length - 1
                });

                if (gameType === 'multi') {
                    playerScores[currentPlayerIndex] = 0;
                    playerLegs[currentPlayerIndex]++;
                    handleLegWin({
                        isMatchOver: playerLegs[currentPlayerIndex] >= legsToWin,
                        winnerName: players[currentPlayerIndex],
                        resetScores: () => {
                            playerScores = [startingScore, startingScore];
                            currentPlayerIndex = 0;
                        },
                        latestScore
                    });
                    return;
                } else {
                    currentScore = 0;
                    playerLegs[0]++;
                    handleLegWin({
                        isMatchOver: playerLegs[0] >= legsToWin,
                        winnerName: "You",
                        resetScores: () => {
                            currentScore = startingScore;
                        },
                        latestScore
                    });
                    return;
                }
            }

            if (newScore > 1) {
                if (gameType === 'multi') {
                    playerScores[currentPlayerIndex] = newScore;
                } else {
                    currentScore = newScore;
                }

                history[history.length - 1].push({
                    player: gameType === 'multi' ? players[currentPlayerIndex] : "You",
                    score: score,
                    darts: 3,
                    isCheckout: false,
                    legIndex: history.length - 1
                });

                inputBuffer = '';

                if (gameType === 'multi') {
                    currentPlayerIndex = (currentPlayerIndex + 1) % players.length;
                }

                updateUI();
            } else {
                alert("Score too high! You can't go below zero.");
            }
        }




        function undoScore() {
            const currentLegHistory = history[history.length - 1];
            if (currentLegHistory.length > 0) {
                const lastScore = currentLegHistory.pop();
                if (gameType === 'multi') {
                    currentPlayerIndex = (currentPlayerIndex - 1 + players.length) % players.length;
                    playerScores[currentPlayerIndex] += lastScore;
                } else {
                    currentScore += lastScore;
                }
                updateUI();
            } else {
                alert("Nothing to undo in this leg.");
            }
        }


        function undoLastDart() {
            if (dartIndex > 0) {
                dartIndex--;
                perDartScores[dartIndex] = null;
                updateUI();
                updateCheckoutSuggestion(getPartialScore());
            }
        }

        function getPartialScore() {
            return perDartScores.reduce((sum, dart) => sum + (dart || 0), 0);
        }

        function setInputMode(mode) {
            inputMode = mode;
            inputBuffer = '';
            perDartScores = [null, null, null];
            dartIndex = 0;
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('show', 'active'));
            document.querySelector(`#${mode === 'total' ? 'total' : 'perdart'}`).classList.add('show', 'active');
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.querySelector(`[data-bs-target="#${mode === 'total' ? 'total' : 'perdart'}"]`).classList.add('active');
            updateUI();
        }

        function setMultiplier(value) {
            multiplier = value;
            document.querySelectorAll('.btn-group .btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent === value);
            });
        }

        function handleLegWin({ isMatchOver, winnerName, resetScores, latestScore }) {
            if (isMatchOver) {
                gameScreen.classList.add('d-none');
                document.getElementById('stats-screen').classList.remove('d-none');
                renderMatchStats();
            } else {
                alert(`${winnerName} won the leg!`);
                resetScores();
                history.push([]);
                inputBuffer = '';
                updateUI();
            }
        }

        function renderMatchStats() {
            const container = document.getElementById('stats-container');
            container.innerHTML = '';

            const allPlayers = gameType === 'multi' ? players : ['You'];

            allPlayers.forEach(playerName => {
                const playerScores = history.flat().filter(h => h.player === playerName);
                const legsByPlayer = history.map((leg, index) => {
                    return leg.filter(h => h.player === playerName).map(entry => ({
                        ...entry,
                        legIndex: index
                    }));
                }).filter(leg => leg.length > 0);

                let totalScore = 0;
                let totalDarts = 0;
                let firstNineTotal = 0;
                let firstNineDarts = 0;
                let checkoutAttempts = 0;
                let checkouts = 0;
                let highestFinish = 0;
                let highestScore = 0;
                let bestLeg = Infinity;
                let worstLeg = 0;

                legsByPlayer.forEach(leg => {
                    let legScore = 0;
                    let legDarts = 0;

                    leg.forEach((entry, i) => {
                        totalScore += entry.score;
                        totalDarts += entry.darts;
                        legScore += entry.score;
                        legDarts += entry.darts;

                        if (i < 3) {
                            firstNineTotal += entry.score;
                            firstNineDarts += entry.darts;
                        }

                        if (entry.isCheckout) {
                            checkouts++;
                            if (entry.score > highestFinish) highestFinish = entry.score;
                        }

                        if (entry.score > highestScore) highestScore = entry.score;
                    });

                    if (legDarts > 0) {
                        if (legDarts < bestLeg) bestLeg = legDarts;
                        if (legDarts > worstLeg) worstLeg = legDarts;
                    }

                    checkoutAttempts += 1;
                });

                const average = totalDarts ? (totalScore / totalDarts) * 3 : 0;
                const first9avg = firstNineDarts ? (firstNineTotal / firstNineDarts) * 3 : 0;
                const checkoutRate = checkoutAttempts ? (checkouts / checkoutAttempts) * 100 : 0;

                const card = document.createElement('div');
                card.className = 'col-md-6 mb-4';
                card.innerHTML = `
                    <div class="card">
                        <div class="card-body">
                            <h4 class="card-title text-center">${playerName}</h4>
                            <ul class="list-group list-group-flush mt-3">
                                <li class="list-group-item">3-Dart Average: <strong>${average.toFixed(2)}</strong></li>
                                <li class="list-group-item">First 9 Average: <strong>${first9avg.toFixed(2)}</strong></li>
                                <li class="list-group-item">Checkout Rate: <strong>${checkoutRate.toFixed(1)}%</strong></li>
                                <li class="list-group-item">Checkouts: <strong>${checkouts}</strong></li>
                                <li class="list-group-item">Highest Finish: <strong>${highestFinish}</strong></li>
                                <li class="list-group-item">Highest Score: <strong>${highestScore}</strong></li>
                                <li class="list-group-item">Best Leg (fewest darts): <strong>${isFinite(bestLeg) ? bestLeg : '-'}</strong></li>
                                <li class="list-group-item">Worst Leg (most darts): <strong>${worstLeg || '-'}</strong></li>
                            </ul>
                        </div>
                    </div>
                `;

                container.appendChild(card);
            });
        }



        function inputDart(base) {
            if (dartIndex >= 3) return;

            let actual;
            if (base === 25 || base === 50) {
                actual = base; // Ignore multiplier for Outer/Bull
            } else {
                actual = base;
                if (multiplier === 'Double') actual *= 2;
                if (multiplier === 'Treble') actual *= 3;
            }

            perDartScores[dartIndex] = actual;
            dartIndex++;

            if (dartIndex === 3) {
                const total = perDartScores.reduce((a, b) => a + b, 0);
                const latestScore = total;

                let current = gameType === 'multi' ? playerScores[currentPlayerIndex] : currentScore;
                const newScore = current - total;
                const lastDart = perDartScores[dartIndex - 1];

                const isValidCheckout =
                    newScore === 0 &&
                    lastDart <= 50 &&
                    lastDart % 2 === 0 &&
                    !bogeyNumbers.includes(current);

                if (isValidCheckout) {
                    history[history.length - 1].push({
                        player: gameType === 'multi' ? players[currentPlayerIndex] : "You",
                        score: total,
                        darts: 3,
                        isCheckout: true,
                        legIndex: history.length - 1
                    });

                    if (gameType === 'multi') {
                        playerScores[currentPlayerIndex] = 0;
                        playerLegs[currentPlayerIndex]++;
                        handleLegWin({
                            isMatchOver: playerLegs[currentPlayerIndex] >= legsToWin,
                            winnerName: players[currentPlayerIndex],
                            resetScores: () => {
                                playerScores = [startingScore, startingScore];
                                currentPlayerIndex = 0;
                            },
                            latestScore
                        });
                        return;
                    } else {
                        currentScore = 0;
                        playerLegs[0]++;
                        handleLegWin({
                            isMatchOver: playerLegs[0] >= legsToWin,
                            winnerName: "You",
                            resetScores: () => {
                                currentScore = startingScore;
                            },
                            latestScore
                        });
                        return;
                    }
                } else if (newScore > 1) {
                    if (gameType === 'multi') {
                        playerScores[currentPlayerIndex] = newScore;
                    } else {
                        currentScore = newScore;
                    }

                    history[history.length - 1].push({
                        player: gameType === 'multi' ? players[currentPlayerIndex] : "You",
                        score: total,
                        darts: 3,
                        isCheckout: false,
                        legIndex: history.length - 1
                    });

                    if (gameType === 'multi') {
                        currentPlayerIndex = (currentPlayerIndex + 1) % players.length;
                    }
                } else {
                    alert("Score too high or invalid checkout!");
                }

                // Reset for next turn
                perDartScores = [null, null, null];
                dartIndex = 0;
            }

            updateUI();
            updateCheckoutSuggestion(getPartialScore());
        }




        function getCheckoutSuggestion(score) {
            const checkouts = {
                170: "T20, T20, Bull", 167: "T20, T19, Bull", 164: "T20, T18, Bull",
                161: "T20, T17, Bull", 160: "T20, T20, D20", 158: "T20, T20, D19",
                157: "T20, T19, D20", 156: "T20, T20, D18", 155: "T20, T19, D19",
                154: "T20, T18, D20", 153: "T20, T19, D18", 152: "T20, T20, D16",
                151: "T20, T17, D20", 150: "T20, T18, D18", 149: "T20, T19, D16",
                148: "T20, T16, D20", 147: "T20, T17, D18", 146: "T20, T18, D16",
                145: "T20, T15, D20", 144: "T20, T20, D12", 143: "T20, T17, D16",
                142: "T20, T14, D20", 141: "T20, T19, D12", 140: "T20, T20, D10",
                139: "T19, T14, D20", 138: "T20, T18, D12", 137: "T17, T18, D16",
                136: "T20, T20, D8", 135: "Bull, T15, D20", 134: "T20, T14, D16",
                133: "T20, T19, D8", 132: "Bull, Bull, D16", 131: "T19, T14, D16",
                130: "T20, T20, D5", 129: "T19, T16, D12", 128: "T18, T14, D16",
                127: "T20, T17, D8", 126: "T19, T19, D6", 125: "25, T20, D20",
                124: "T20, T16, D8", 123: "T19, T16, D9", 122: "T18, T20, D4",
                121: "T20, T11, D14", 120: "T20, 20, D20", 119: "T19, 10, D16",
                118: "T20, 18, D20", 117: "T20, 17, D20", 116: "T20, 16, D20",
                115: "T20, 15, D20", 114: "T20, 14, D20", 113: "T20, 13, D20",
                112: "T20, 12, D20", 111: "T20, 11, D20", 110: "T20, 10, D20",
                109: "T20, 9, D20", 108: "T20, 8, D20", 107: "T20, 7, D20",
                106: "T20, 6, D20", 105: "T20, 5, D20", 104: "T18, 18, D16",
                103: "T17, 12, D20", 102: "T20, 10, D16", 101: "T17, 10, D20",
                100: "T20, D20", 99: "T19, 10, D16", 98: "T20, D19", 97: "T19, D20",
                96: "T20, D18", 95: "T19, D19", 94: "T18, D20", 93: "T19, D18",
                92: "T20, D16", 91: "T17, D20", 90: "T18, D18", 89: "T19, D16",
                88: "T16, D20", 87: "T17, D18", 86: "T18, D16", 85: "T15, D20",
                84: "T20, D12", 83: "T17, D16", 82: "Bull, D16", 81: "T15, D18",
                80: "T20, D10", 79: "T13, D20", 78: "T18, D12", 77: "T15, D16",
                76: "T20, D8", 75: "T17, D12", 74: "T14, D16", 73: "T19, D8",
                72: "T16, D12", 71: "T13, D16", 70: "T18, D8", 69: "T19, D6",
                68: "T20, D4", 67: "T17, D8", 66: "T10, D18", 65: "25, D20",
                64: "T16, D8", 63: "T13, D12", 62: "T10, D16", 61: "25, D18",
                60: "20, D20", 59: "19, D20", 58: "18, D20", 57: "17, D20",
                56: "16, D20", 55: "15, D20", 54: "14, D20", 53: "13, D20",
                52: "12, D20", 51: "11, D20", 50: "10, D20", 49: "9, D20",
                48: "8, D20", 47: "15, D16", 46: "14, D16", 45: "13, D16",
                44: "12, D16", 43: "11, D16", 42: "10, D16", 41: "9, D16",
                40: "D20", 39: "7, D16", 38: "D19", 37: "5, D16", 36: "D18",
                35: "3, D16", 34: "D17", 33: "1, D16", 32: "D16", 31: "15, D8",
                30: "D15", 29: "13, D8", 28: "D14", 27: "11, D8", 26: "D13",
                25: "9, D8", 24: "D12", 23: "7, D8", 22: "D11", 21: "5, D8",
                20: "D10", 19: "3, D8", 18: "D9", 17: "1, D8", 16: "D8",
                15: "7, D4", 14: "D7", 13: "5, D4", 12: "D6", 11: "3, D4",
                10: "D5", 9: "1, D4", 8: "D4", 7: "3, D2", 6: "D3",
                5: "1, D2", 4: "D2", 3: "1, D1", 2: "D1"
            };

            return checkouts[score] || null;
        }

        function updateCheckoutSuggestion(scoreOverride = null) {
            const activeScore = gameType === 'multi' ? playerScores[currentPlayerIndex] : currentScore;
            const score = scoreOverride !== null ? activeScore - scoreOverride : activeScore;
            const suggestionBox = document.getElementById('checkout-suggestion');
            const suggestionText = document.getElementById('checkout-text');
            if (bogeyNumbers.includes(score)) {
                suggestionText.textContent = "No checkout possible";
                suggestionBox.classList.remove('d-none');
                suggestionBox.classList.remove('alert-info');
                suggestionBox.classList.add('alert-danger');
            } else {
                const suggestion = getCheckoutSuggestion(score);
                if (suggestion) {
                    suggestionText.textContent = suggestion;
                    suggestionBox.classList.remove('d-none');
                    suggestionBox.classList.remove('alert-danger');
                    suggestionBox.classList.add('alert-info');
                } else {
                    suggestionBox.classList.add('d-none');
                }
            }
        }

        function goToMenu() {
            const confirmReset = confirm("Are you sure you want to quit the game and return to the main menu?");
            if (!confirmReset) return;

            players = [];
            playerScores = [];
            playerLegs = [];

            gameScreen.classList.add('d-none');
            startScreen.classList.add('d-none');
            modeScreen.classList.remove('d-none');

            currentScore = startingScore;
            history.length = 0;
            inputBuffer = '';
            perDartScores = [null, null, null];
            dartIndex = 0;
            multiplier = 'Single';
            inputMode = 'total';

            setInputMode('total');
            setMultiplier('Single');

            document.getElementById('win-screen').classList.add('d-none');
            document.getElementById('checkout-suggestion').classList.add('d-none');
            document.getElementById('win-screen').innerHTML = `
        <strong>ðŸŽ‰ Game Over!</strong> You've checked out successfully.
    `;

            updateUI();
        }



        function updateUI() {
            renderPlayerScores();

            if (currentScore === 0) {
                document.getElementById('win-screen').classList.remove('d-none');
            } else {
                document.getElementById('win-screen').classList.add('d-none');
            }

            updateCheckoutSuggestion(getPartialScore());

            document.getElementById('score-display').textContent = inputBuffer || '0';

            document.querySelectorAll('.dart-score-box').forEach((box, index) => {
                const score = perDartScores[index];
                box.textContent = score !== null ? (score === 0 ? 'M' : score) : '-';
                box.classList.toggle('active', index === dartIndex);
            });

            const historyList = document.getElementById('score-history');
            historyList.innerHTML = '';

            if (gameType === 'multi') {
                const row = document.createElement('div');
                row.className = 'row';

                const playerHistories = players.map(name => ({
                    name,
                    list: [],
                }));

                const currentLegIndex = history.length - 1;
                const currentLeg = history[currentLegIndex];

                currentLeg.forEach(entry => {
                    const player = playerHistories.find(p => p.name === entry.player);
                    if (player) {
                        player.list.push(`-${entry.score}`);
                    }
                });

                playerHistories.forEach(player => {
                    const col = document.createElement('div');
                    col.className = 'col';

                    const card = document.createElement('div');
                    card.className = 'card mb-3';

                    const cardBody = document.createElement('div');
                    cardBody.className = 'card-body';

                    const heading = document.createElement('h6');
                    heading.textContent = player.name;
                    heading.className = 'card-title text-center';

                    const ul = document.createElement('ul');
                    ul.className = 'list-group';

                    player.list.slice().reverse().forEach(text => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item';
                        li.textContent = text;
                        ul.appendChild(li);
                    });

                    cardBody.appendChild(heading);
                    cardBody.appendChild(ul);
                    card.appendChild(cardBody);
                    col.appendChild(card);
                    row.appendChild(col);
                });

                historyList.appendChild(row);
            } else {
                const currentLeg = history[history.length - 1];
                currentLeg.slice().reverse().forEach(entry => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item';
                    li.textContent = `-${entry.score}`;
                    historyList.appendChild(li);
                });
            }
        }





        function renderPlayerScores() {
            const playersContainer = document.getElementById('players');
            playersContainer.innerHTML = '';

            if (gameType === 'multi') {
                players.forEach((name, index) => {
                    const playerDiv = document.createElement('div');
                    playerDiv.className = `text-center flex-fill ${index === currentPlayerIndex ? 'fw-bold text-primary' : ''}`;
                    playerDiv.innerHTML = `
                    <div>${name}</div>
                    <div style="font-size: 1.5rem;">${playerScores[index]}</div>
                    <div style="font-size: 0.9rem;">Legs: ${playerLegs[index]}</div>
                `;
                    playersContainer.appendChild(playerDiv);
                });
            } else {
                playersContainer.innerHTML = `
            <div class="text-center w-100">
                <div>Score</div>
                <div style="font-size: 1.5rem;">${currentScore}</div>
            </div>
        `;
            }
        }


        // Show game type picker on load
        modeScreen.classList.remove('d-none');
        startScreen.classList.add('d-none');
        gameScreen.classList.add('d-none');

        updateUI();
    </script>
</body>

</html>